name: FoD Auth - User Password

on:
  workflow_dispatch:
  
jobs:
  fod-auth:
    runs-on: ubuntu-latest

    steps:
      - name: Authenticate to Fortify on Demand
        run: |
          echo "Authenticating to Fortify on Demand with user/password..."

          RESPONSE=$(curl -s -X POST \
            https://api.ams.fortify.com/oauth/token \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "grant_type=password" \
            -d "username=${{ secrets.FOD_USER }}" \
            -d "password=${{ secrets.FOD_PASSWORD }}" \
            -d "tenant=${{ secrets.FOD_TENANT }}" \
            -d "scope=api-tenant")

          ACCESS_TOKEN=$(echo "$RESPONSE" | jq -r .access_token)

          if [ "$ACCESS_TOKEN" = "null" ] || [ -z "$ACCESS_TOKEN" ]; then
            echo "ERROR: Authentication failed"
            echo "$RESPONSE"
            exit 1
          fi

          echo "Authentication successful"
          echo "FOD_ACCESS_TOKEN=$ACCESS_TOKEN" >> $GITHUB_ENV
